<!doctype html>
<html data-theme="light">
      <!-- 
  
  NOTE: This plugin will not be visible on public views of a channel. 
        If you intend to make your channel public, consider using the
        MATLAB Visualization App to create your visualizations.
  
  -->  
    <head>
        <meta charset="utf-8">
        <title>Ronamu Rusys</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- %%PLUGIN_CSS%% -->
        <link rel="stylesheet" href="https://leeoniya.github.io/uPlot/dist/uPlot.min.css">
        <!-- Pico.css -->
        <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css"/>
        <style>

            svg {
               /* border: 1px solid blue; */
               max-height: 100%;
               max-width: 80%;
            }
        </style>
        <!-- /%%PLUGIN_CSS%% -->
    </head>
    <body>
        <main class="container">
            <hr/>
            <article id="article">
                <div id="panel" class="chartPanel">
                    <svg
   viewBox="0 0 1200 800"
   preserveAspectRatio="xMidYMin slice"
   version="1.1"
   id="svg44"
   sodipodi:docname="test_scale.svg"
   inkscape:version="1.2.2 (b0a8486541, 2022-12-01)"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs48" />
  <sodipodi:namedview
     id="namedview46"
     pagecolor="#ffffff"
     bordercolor="#000000"
     borderopacity="0.25"
     inkscape:showpageshadow="2"
     inkscape:pageopacity="0.0"
     inkscape:pagecheckerboard="0"
     inkscape:deskcolor="#d1d1d1"
     showgrid="false"
     inkscape:zoom="2.36"
     inkscape:cx="773.51695"
     inkscape:cy="648.94068"
     inkscape:window-width="2494"
     inkscape:window-height="1531"
     inkscape:window-x="66"
     inkscape:window-y="32"
     inkscape:window-maximized="1"
     inkscape:current-layer="svg44"
     showguides="false" />
  <polygon
     points="23,370 563,191 1106,370 "
     style="fill:#ffffff;fill-opacity:0.1;stroke:#808080;stroke-width:5;stroke-opacity:0.9"
     id="polygon2"
     transform="matrix(-1.0986165,0,0,0.99965817,1218.732,-186.2391)" />
  <rect
     class="homeWalls"
     width="1148.0944"
     height="310.83481"
     x="24.517958"
     y="452.66595"
     style="fill:#ffffff;fill-opacity:0.1;stroke:#808080;stroke-width:6.29852;stroke-opacity:0.9"
     id="rect4" />
  <rect
     class="homeWalls"
     width="1148.556"
     height="266.81537"
     x="-1172.8431"
     y="186.14848"
     style="fill:#ffffff;fill-opacity:0.1;stroke:#808080;stroke-width:5.83669;stroke-opacity:0.9"
     id="rect4-3"
     transform="scale(-1,1)" />
  <circle
     cx="346"
     cy="143"
     fill="#5b5b5b"
     stroke="#000000"
     id="ellipse6"
     r="0" />
  <g
     id="g12"
     transform="translate(-8.4471906,117.43678)">
    <ellipse
       rx="22.5"
       ry="15"
       cx="156.5"
       cy="411"
       style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:1;stroke-opacity:0.9"
       id="ellipse8" />
    <rect
       x="115"
       y="412"
       width="83"
       height="142"
       style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:1;stroke-opacity:0.9"
       id="rect10" />
  </g>
  <!--Boileris-->
  <path
     id="rect16"
     style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:1;stroke-opacity:0.9"
     d="M 796.05273 545.9375 L 796.05273 666.9375 L 796.55273 666.9375 A 89.5 14 0 0 0 886.05273 680.9375 A 89.5 14 0 0 0 975.55273 666.9375 L 976.05273 666.9375 L 976.05273 545.9375 L 796.05273 545.9375 z " />
  <ellipse
     cx="886.0528"
     cy="543.93683"
     rx="90"
     ry="14"
     style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:1;stroke-opacity:0.9"
     id="ellipse18" />
  <!--/Boileris-->
  <path
     id="rect22"
     style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:1;stroke-opacity:0.9"
     d="M 506.55273 579.4375 L 506.55273 626.97656 A 28.5 14 0 0 0 506.05273 629.4375 A 28.5 14 0 0 0 506.55273 631.89648 L 506.55273 633.4375 L 507.2832 633.4375 A 28.5 14 0 0 0 534.55273 643.4375 A 28.5 14 0 0 0 561.82227 633.4375 L 562.55273 633.4375 L 562.55273 631.89648 A 28.5 14 0 0 0 563.05273 629.4375 A 28.5 14 0 0 0 562.55273 626.8418 L 562.55273 579.4375 L 506.55273 579.4375 z " />
  <ellipse
     cx="534.5528"
     cy="582.43683"
     rx="28.5"
     ry="14"
     style="fill:#808080;fill-opacity:1;stroke:#ffffff;stroke-width:1;stroke-opacity:0.9"
     id="ellipse24" />
  <rect
     fill="#ff0000"
     x="194.55283"
     y="536.43683"
     width="602"
     height="10"
     id="rect26" />
  <rect
     fill="#0000ff"
     x="191.55283"
     y="659.43677"
     width="602"
     height="10"
     id="rect28" />
  <rect
     fill="#0000ff"
     x="529.5528"
     y="643.43677"
     width="10"
     height="23"
     id="rect30" />
  <rect
     fill="#ff0000"
     x="531.5528"
     y="543.43683"
     width="10"
     height="23"
     id="rect32" />
  <rect
     fill="#ff0000"
     x="977.5528"
     y="567.43683"
     width="70"
     height="10"
     id="rect34" />
  <rect
     fill="#0000ff"
     x="977.5528"
     y="627.43677"
     width="70"
     height="10"
     id="rect36" />
  <text
     id="tempContainer_field1"
     x="860"
     y="590"
     fill="#008000"
     stroke="#383838"
     font-size="30px">t1</text>
  <text
     id="tempContainer_field2"
     x="860"
     y="630"
     fill="#000000"
     stroke="#383838"
     
     font-size="30px">t2</text>
  <text
     id="tempContainer_field3"
     x="860"
     y="670"
     fill="#0000ff"
     stroke="#383838"
     font-size="30px">t3</text>
  <text
     id="tempContainer_field4"
     x="200"
     y="530"
     fill="#ff0000"
     stroke="#383838"
     font-size="30px">t4</text>
  <text
     id="tempContainer_field5"
     x="1110.6361"
     y="62.758095"
     fill="#a52a2a"
     stroke="#000000"
     font-size="30px">t5</text>
  <text
     id="created_at"
     x="21.660807"
     y="60.127956"
     fill="#a52a2a"
     stroke="#000000"
     font-size="30px">20000-00-00T00:00:00</text>
</svg>

                </div>
                
            </article>
            <hr/>
            <details id="chartPanmel">
                <summary>Grafikas</summary>
                <article>
                    <label for="resultRange">Rezultatų: <span id="resultRangeValue">#</span>
                        <input id="resultRange" name="resultRange" type ="range" min="10" max="200" value="10"/>
                    </label>
                    <div id="chart1" class="chartPanel"></div>
                </article>
            </details>
        </main>

         <!-- %%PLUGIN_JAVASCRIPT%% -->
            <script src="https://leeoniya.github.io/uPlot/dist/uPlot.iife.min.js"> </script>
            <script>
            var G_CHART_LOADED=false;
            var G_uPlot=undefined;
            var G_maxResult=undefined;

            window.addEventListener("resize", e => {
				if(G_uPlot!=undefined){
                    G_uPlot.setSize(getSize());
                }
			});

            document.getElementById("resultRange").onchange = function(e) { 
                // document.getElementById("resultRange").value=G_maxResult;
                G_maxResult=this.value;
                localStorage.setItem("G_maxResult",G_maxResult)
                document.getElementById("chart1").innerHTML='';
                document.getElementById("resultRangeValue").textContent=G_maxResult; 
                fetchDataForChart(G_maxResult);
            }

            window.onload = (event) => {
                console.log("page is fully loaded2");
                const details = document.getElementById("chartPanmel");
                setTimeout(() => fetchDataForDashboard(), 1000);
                details.addEventListener("toggle", (event) => {
                    if (details.open && G_CHART_LOADED == false) {
                        G_CHART_LOADED=true;
                        console.time("chart");
                        G_maxResult=localStorage.getItem("G_maxResult");
                        if(G_maxResult == undefined){
                            G_maxResult=10;
                            localStorage.setItem("G_maxResult",G_maxResult)
                        }
                        document.getElementById("resultRange").value=G_maxResult;
                        document.getElementById("resultRangeValue").textContent=G_maxResult;    
                        fetchDataForChart(G_maxResult);

                    } else {
                        /* the element was toggled closed */
                    }
                });
            };

            const ltNames = {
                MMMM: ["Sausis","Vasaris","Kovas","Balandis","Gegužė","Birželis","Liepa","Rugpjūtis","Rugsėjis","Spalis","Lapkritis","Gruodis"],
                MMM:  ["Saus","Vasr","Kovs","Baln","Gegž","Birž","Liep","Rugp","Rugs","Spal","Lapk","Gruo"],
                WWWW: ["Sekmadienis","Pirmadienis","Antradienis","Trečiadienis","Ketvirtadienis","Penktadienis","Šeštadienis"],
                WWW:  ["Sek","Pir","Ant","Tre","Ket","Pen","Šeš"],
            };

            function createUrl(resultCount){
                const params = window.location.search.substr(1);
                const channel_key=params.split("/");
                if(channel_key.length == 2){
                    return `https://api.thingspeak.com/channels/${channel_key[0]}/feeds.json?timezone=Europe%2FVilnius&api_key=${channel_key[1]}&results=${resultCount}`;
                }
                return "";
            }


            function fetchDataForDashboard(){
                const fetchUrl = createUrl(1);
                console.log("fetcDataForDashboard:", fetchUrl);
                fetch(fetchUrl)
                .then(r => r.json()).then(packed => {
                    const first = packed.feeds[0];
                    console.log("feeds", first);
                    var field1 = Math.round(first.field1);
                    var field2 = Math.round(first.field2);
                    var field3 = Math.round(first.field3);
                    var field4 = Math.round(first.field4);
                    //var field5 = first.field5;//outside
                    var created_at = first.created_at;
                    console.log("field1", field1);
                    console.log("created_at", created_at);
                    document.getElementById("tempContainer_field1").textContent = field1;
                    document.getElementById("tempContainer_field2").textContent = field2;
                    document.getElementById("tempContainer_field3").textContent = field3;
                    document.getElementById("tempContainer_field4").textContent = field4;
                    //document.getElementById("tempContainer_field5").textContent = field5;
                    document.getElementById("created_at").textContent = timeAgo(created_at);
                });
            }

            function fetchDataForChart(resultCount){
                const fetchUrl = createUrl(resultCount);
                console.log("fetchDataForChart", fetchUrl);
                fetch(fetchUrl)
                .then(r => r.json()).then(packed => {
                    let data = prepData(packed);
                    setTimeout(() => makeChart(data), 0);
                });
            }

            function timeAgo(input) {
                const date = (input instanceof Date) ? input : new Date(input);
                const formatter = new Intl.RelativeTimeFormat('lt');
                const ranges = {
                    years: 3600 * 24 * 365,
                    months: 3600 * 24 * 30,
                    weeks: 3600 * 24 * 7,
                    days: 3600 * 24,
                    hours: 3600,
                    minutes: 60,
                    seconds: 1
                };
                const secondsElapsed = (date.getTime() - Date.now()) / 1000;
                for (let key in ranges) {
                    if (ranges[key] < Math.abs(secondsElapsed)) {
                    const delta = secondsElapsed / ranges[key];
                    return formatter.format(Math.round(delta), key);
                    }
                }
            }

            function prepData(responseData){
                console.log("prepData(responseData)", responseData);
                const feeds = responseData.feeds;
                let data = [
                    feeds.map((v,i) => new Date(v.created_at)/1000),
                    feeds.map((v,i) => v.field1),//temp1
                    feeds.map((v,i) => v.field2),//temp2
                    feeds.map((v,i) => v.field3),//temp3
                    feeds.map((v,i) => v.field4),//temp4
                    //feeds.map((v,i) => v.field5),//outside
                    

                ];
                return data;

                
            }

            function getSize() {
                const resize = {
					width: window.innerWidth - 300,
					height: window.innerHeight - 200,
				};
                console.log("getSize()", resize);
				return resize; 
			}

            function makeChart(data) {
                let fmtDate = uPlot.fmtDate("{DD} {HH}:{mm}");
                const opts = {
                    title: "Namai",
                    ...getSize(),
                    tzDate: ts => uPlot.tzDate(new Date(ts * 1e3), 'Europe/Vilnius'),
                    fmtDate: tpl => uPlot.fmtDate(tpl, ltNames),
                    axes: [
                        {values:[
                            // tick incr  default       year                        month   day                  hour   min               sec  mode 
                            [3600*24*365,"{YYYY}",      null,                       null, null,                  null, null,              null, 1],
                            [3600*24*28, "{MMM}",       "\n{YYYY}",                 null, null,                  null, null,              null, 1],
                            [3600*24,    "{D}/{M}",     "\n{YYYY}",                 null, null,                  null, null,              null, 1],
                            [3600,       "{HH}",        "\n{YY}/{M}/{D}",           null, "\n{D}/{M}",           null, null,              null, 1],
                            [60,         "{HH}:{mm}",   "\n{YY}/{M}/{D}",           null, "\n{D}/{M}",           null, null,              null, 1],
                            [1,          ":{ss}",       "\n{YY}/{M}/{D} {HH}:{mm}", null, "\n{D}/{M} {HH}:{mm}", null, "\n{HH}:{mm}",     null, 1],
                            [0.001,      ":{ss}.{fff}", "\n{YY}/{M}/{D} {HH}:{mm}", null, "\n{D}/{M} {HH}:{mm}", null, "\n{HH}:{mm}",     null, 1],
                        ]},
                        {}
                    ],
                    series: [
                        {
                            value: "{YYYY}-{MM}-{DD} {HH}:{mm}:{ss}"
                        },
                        {
                            stroke: "green", label: "temp1",
                        },
                        {
                            stroke: "black", label: "temp2",
                        },
                        {
                            stroke: "blue", label: "temp3",
                        },
                        {
                            stroke: "red", label: "Iš katilo",//t4
                        },
                        /*{
                            stroke: "brown", label: "Lauko",
                        },*/
                    ]
                };

                G_uPlot = new uPlot(opts, data, document.getElementById("chart1"));
                Promise.resolve().then(() => {
                    console.timeEnd("chart");
                    window.scrollTo(0, document.body.scrollHeight);
                });
            }
            </script>
         <!-- /%%PLUGIN_JAVASCRIPT%% -->
    </body>
</html>
